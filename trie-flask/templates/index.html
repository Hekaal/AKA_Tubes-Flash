<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Trie Autocomplete AKA (Flask)</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <script defer src="{{ url_for('static', filename='app.js') }}"></script>
</head>

<body>
  <!-- Top Bar -->
  <header class="topbar">
    <div class="brand">
      <div class="logo">T</div>
      <div>
        <div class="brand-title">Trie Autocomplete</div>
        <div class="brand-sub">Iteratif vs Rekursif ‚Äî Tubes AKA</div>
      </div>
    </div>

    <div class="top-actions">
      <button class="btn btn-ghost" id="toggleTheme" type="button" title="Toggle theme">üåì</button>
      <a class="btn btn-ghost" href="/" title="Refresh">‚Üª</a>
    </div>
  </header>

  <main class="container">
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <section class="card alert">
          {% for msg in messages %}
            <div class="alert-item">{{ msg }}</div>
          {% endfor %}
        </section>
      {% endif %}
    {% endwith %}

    <section class="grid2">
      <!-- Upload -->
      <section class="card">
        <div class="card-head">
          <h2>1) Upload Dataset</h2>
          <span class="badge">{{ "Loaded" if state.csv_path else "Not loaded" }}</span>
        </div>

        <p class="muted">CSV wajib punya kolom <code>product_name</code>. Dataset kamu besar? aman, nanti dibatasi via MAX_ROWS.</p>

        <form action="/upload" method="post" enctype="multipart/form-data" class="form">
          <label class="file">
            <input type="file" name="file" accept=".csv" required>
            <span>Pilih CSV‚Ä¶</span>
          </label>
          <button class="btn btn-primary" type="submit">Upload</button>
        </form>

        <div class="meta">
          <div><b>File:</b> {{ state.csv_name if state.csv_name else "-" }}</div>
          <div><b>Total baris:</b> {{ state.total_rows if state.total_rows else "-" }}</div>
        </div>
      </section>

      <!-- Run -->
      <section class="card">
        <div class="card-head">
          <h2>2) Eksperimen</h2>
          <span class="badge badge-soft">Manual input</span>
        </div>

        <p class="muted">
          Isi <b>N list</b> (iterasi ukuran input) dan <b>prefix</b> (1 baris 1 prefix).
          Untuk membuat grafik lebih ‚Äúwajar‚Äù, aktifkan smoothing (moving average).
        </p>

        <form action="/run" method="post" class="form" id="runForm">
          <div class="grid4">
            <div>
              <label>MAX_ROWS</label>
              <input name="max_rows" type="number" min="1000" step="1000"
                     value="{{ state.params.max_rows }}">
              <div class="hint">Batas baris dipakai (boleh sampai total).</div>
            </div>
            <div>
              <label>MAX_LEN</label>
              <input name="max_len" type="number" min="30" max="200" step="10"
                     value="{{ state.params.max_len }}">
              <div class="hint">Potong panjang teks agar Trie stabil.</div>
            </div>
            <div>
              <label>TOP_K</label>
              <input name="top_k" type="number" min="1" max="50" step="1"
                     value="{{ state.params.top_k }}">
              <div class="hint">Jumlah suggestion (top-k).</div>
            </div>
            <div>
              <label>MAX_DEPTH</label>
              <input name="max_depth" type="number" min="50" max="500" step="10"
                     value="{{ state.params.max_depth }}">
              <div class="hint">Batas kedalaman rekursif.</div>
            </div>
          </div>

          <div class="grid2">
            <div>
              <label>Smoothing Window</label>
              <input name="smooth_window" type="number" min="1" max="9" step="1"
                     value="{{ state.params.smooth_window }}">
              <div class="hint">Moving average (1=off). Rekomendasi: 3.</div>
            </div>
            <div class="tip">
              <b>Tips dataset 1 juta baris:</b>
              <ul>
                <li>Mulai MAX_ROWS: 50k‚Äì200k</li>
                <li>MAX_LEN: 60‚Äì100</li>
                <li>N list bertahap: 1k, 5k, 10k, 50k, 100k</li>
              </ul>
            </div>
          </div>

          <label>N list (pisah koma)</label>
          <input name="n_list" id="nList" placeholder="contoh: 1000,5000,10000,50000"
                 value="{{ state.params.n_list }}">

          <label>Prefix uji (1 baris = 1 prefix)</label>
          <textarea name="prefixes" id="prefixes" rows="6" placeholder="contoh:
win
lug
tsa
blue
carry">{{ state.params.prefixes }}</textarea>

          <div class="actions">
            <button class="btn btn-primary" type="submit" id="runBtn">RUN Eksperimen</button>
            <button class="btn btn-ghost" type="button" id="clearInputs">Clear input</button>
          </div>

          <div class="small muted">
            Setelah klik RUN, halaman akan memproses (bisa agak lama tergantung N). Jangan spam klik.
          </div>
        </form>
      </section>
    </section>

    {% if state.png_iter %}
      <section class="card">
        <div class="card-head">
          <h2>3) Grafik</h2>
          <div class="right">
            <a class="btn btn-ghost" href="/download/agg.csv">Download agregasi CSV</a>
            <a class="btn btn-ghost" href="/download/res.csv">Download hasil CSV</a>
          </div>
        </div>

        <div class="grid2">
          <div class="plot">
            <h3>Iteratif</h3>
            <img alt="Iterative plot" src="data:image/png;base64,{{ state.png_iter|b64 }}">
          </div>
          <div class="plot">
            <h3>Rekursif</h3>
            <img alt="Recursive plot" src="data:image/png;base64,{{ state.png_rec|b64 }}">
          </div>
        </div>

        <div class="plot">
          <h3>Gabungan (Trend)</h3>
          <img alt="Combined plot" src="data:image/png;base64,{{ state.png_both|b64 }}">
        </div>

        <div class="note">
          <b>Catatan laporan:</b> Fluktuasi runtime wajar karena scheduling CPU, cache, dan garbage collection.
          Smoothing (moving average) hanya membantu memperjelas tren, bukan mengubah data.
        </div>
      </section>

      <section class="grid2">
        <section class="card">
          <div class="card-head">
            <h2>4) Tabel Agregasi</h2>
            <span class="badge badge-soft">Mean per N</span>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  {% for c in state.agg_cols %}
                    <th>{{ c }}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for r in state.agg %}
                  <tr>
                    {% for c in state.agg_cols %}
                      <td>{{ r[c] }}</td>
                    {% endfor %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </section>

        <section class="card">
          <div class="card-head">
            <h2>5) Tabel Hasil</h2>
            <span class="badge badge-soft">200 baris pertama</span>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  {% for c in state.res_cols %}
                    <th>{{ c }}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for r in state.res_head %}
                  <tr>
                    {% for c in state.res_cols %}
                      <td>{{ r[c] }}</td>
                    {% endfor %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </section>
      </section>
    {% endif %}
  </main>

  <!-- Loading Overlay -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="overlay-card">
      <div class="spinner"></div>
      <div class="overlay-title">Sedang memproses eksperimen‚Ä¶</div>
      <div class="overlay-sub">Jangan tutup tab ini. Waktu proses tergantung MAX_ROWS & N list.</div>
    </div>
  </div>

  <footer class="footer">
    <span>Flask App ‚Ä¢ Trie Autocomplete AKA</span>
    <span class="muted">Tip: untuk dataset 1 juta baris, naikkan bertahap.</span>
  </footer>
</body>
</html>
